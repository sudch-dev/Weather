<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weather • {{ city }}, {{ region }}</title>
  <style>
    :root { --bg:#0b132b; --card:#1c2541; --mut:#3a506b; --acc:#5bc0be; --txt:#e0fbfc; --alert:#ff6b6b; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--txt); }
    header { padding:12px 16px; border-bottom:1px solid var(--mut); position:sticky; top:0; background:linear-gradient(180deg,var(--bg),rgba(11,19,43,.85)); backdrop-filter:saturate(1.2) blur(2px);}
    h1{margin:0;font-size:1.1rem;}
    a{color:var(--acc);text-decoration:none;} a:hover{text-decoration:underline;}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--mut);color:var(--txt);font-size:.85rem;}
    .muted{color:#cfe8ea;opacity:.85;}
    .card{background:var(--card);border:1px solid var(--mut);border-radius:12px;padding:16px;}
    .blink{animation:bl 1s step-start infinite;color:#fff;background:var(--alert);border-radius:8px;padding:2px 6px;}
    @keyframes bl{50%{opacity:.35}}
    .searchbox{position:relative;display:inline-block;}
    .searchbox input{padding:8px 12px;border-radius:8px;border:1px solid var(--mut);background:#0f1b3d;color:var(--txt);min-width:220px;}
    .suggestions{position:absolute;top:40px;left:0;right:0;background:#0f1b3d;border:1px solid var(--mut);border-radius:8px;max-height:240px;overflow:auto;z-index:5;}
    .suggestions div{padding:8px 10px;cursor:pointer;border-bottom:1px solid #1f2a4c;} .suggestions div:hover{background:#122252;}
    .hidden{display:none;}

    /* iOS-like day strip + mode picker */
    .strip{display:flex;gap:8px;overflow:auto;padding:6px 2px;}
    .day{min-width:90px;text-align:center;padding:10px;border-radius:10px;border:1px solid var(--mut);background:#0f1b3d;}
    .day.active{outline:2px solid var(--acc);}
    .mode{display:flex;flex-direction:column;gap:6px;}
    .mode button{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px;border:1px solid var(--mut);background:#0f1b3d;color:var(--txt);border-radius:10px;width:100%;cursor:pointer}
    .mode button.active{outline:2px solid var(--acc);}
    .kpi{display:flex;align-items:center;gap:16px;}
    .kpi .big{font-weight:800;font-size:2.2rem;min-width:6ch;}
    canvas{width:100%;height:260px;background:linear-gradient(180deg,#0f1b3d,rgba(15,27,61,.3));border-radius:12px;border:1px solid var(--mut);}
    .legend{display:flex;gap:16px;margin:8px 0;}
    .legend span::before{content:'';display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px;background:currentColor;opacity:.9;}
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between;gap:12px">
      <h1>Weather • {{ city }}, {{ region }} <span class="muted">| IST: {{ now_ist }}</span></h1>
      <div class="row">
        <a class="pill" href="/?city=durgapur">Durgapur</a>
        <a class="pill" href="/?city=kolkata">Kolkata</a>
        <div class="searchbox">
          <input id="place" type="text" placeholder="Search place…" autocomplete="off"/>
          <div id="sugs" class="suggestions hidden"></div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">

    <!-- TODAY SUMMARY -->
    <section class="card">
      {% set t = payload['today'] %}
      {% set cur = payload['current'] %}
      <div class="kpi">
        <div class="big {{ 'blink' if t['alert'] else '' }}">
          {{ t['temperature'] if t['temperature'] is not none else "—" }}°C
        </div>
        <div>
          <div>{{ cur['weather_desc'] or "—" }}</div>
          <div class="muted">H/L today:
            {% set d0 = payload['daily'][0] if payload['daily'] else {} %}
            {{ d0.get('temperature_2m_max','—') }}° / {{ d0.get('temperature_2m_min','—') }}°
          </div>
          <div class="muted">Updated: {{ cur['time_ist'] or "—" }}</div>
        </div>
      </div>
      <div style="margin-top:8px">
        Chance of Precipitation:
        <strong class="{{ 'blink' if t['precip_alert'] else '' }}">{{ t['precip_prob'] if t['precip_prob'] is not none else '—' }}%</strong>
      </div>
    </section>

    <!-- CHART CARD -->
    <section class="card" id="chartCard">
      <!-- Day strip -->
      <div class="strip" id="dayStrip">
        {% for d in payload['daily'] %}
          <div class="day {{ 'active' if loop.first else '' }}"
               data-dayindex="{{ loop.index0 }}"
               data-date="{{ d['date'] }}">
            <div class="muted" style="font-size:.8rem">
              {{ ['S','M','T','W','T','F','S'][loop.index0 % 7] }}
            </div>
            <div style="font-weight:700">{{ d['date'] }}</div>
            <div class="muted" style="font-size:.85rem">{{ d.get('weather_desc','') }}</div>
          </div>
        {% endfor %}
      </div>

      <!-- Mode picker + canvas -->
      <div class="grid" style="grid-template-columns:260px 1fr;">
        <div class="mode">
          <button class="active" data-mode="conditions">Conditions<span class="muted">Temp • Feels Like</span></button>
          <button data-mode="uv">UV Index</button>
          <button data-mode="wind">Wind</button>
          <button data-mode="precip">Precipitation</button>
          <button data-mode="humidity">Humidity</button>
          <button data-mode="visibility">Visibility</button>
          <button data-mode="pressure">Pressure</button>
        </div>

        <div>
          <canvas id="chart"></canvas>
          <div class="legend" id="legend"></div>
          <div class="muted" id="subtitle">The actual temperature.</div>
        </div>
      </div>
    </section>

    <!-- DETAILS -->
    <section class="card">
      <h3 style="margin-top:0">Details</h3>
      <div class="row">
        <span class="pill">Wind: {{ cur['windspeed'] if cur['windspeed'] is not none else '—' }} km/h</span>
        <span class="pill">Dir: {{ cur['winddirection'] if cur['winddirection'] is not none else '—' }}°</span>
        <span class="pill">Gen: {{ payload['meta']['generationtime_ms'] }} ms</span>
        <span class="pill">TZ: {{ payload['meta']['timezone'] }}</span>
        <span class="pill">Elevation: {{ payload['meta']['elevation'] if payload['meta']['elevation'] is not none else '—' }}</span>
      </div>
    </section>

    <!-- AIR QUALITY (unchanged table) -->
    <section class="card">
      <h3 style="margin-top:0">Air Quality (Next 24 Hours)</h3>
      <div class="muted">US AQI (overall) shown hourly below.</div>
      <div style="max-height:320px; overflow:auto; border:1px solid var(--mut); border-radius:8px; margin-top:8px">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:8px; border-bottom:1px dashed #2d3a55;">Time (IST)</th>
              <th style="text-align:left; padding:8px; border-bottom:1px dashed #2d3a55;">US AQI</th>
              <th style="text-align:left; padding:8px; border-bottom:1px dashed #2d3a55;">PM2.5</th>
              <th style="text-align:left; padding:8px; border-bottom:1px dashed #2d3a55;">PM10</th>
              <th style="text-align:left; padding:8px; border-bottom:1px dashed #2d3a55;">NO₂</th>
              <th style="text-align:left; padding:8px; border-bottom:1px dashed #2d3a55;">SO₂</th>
              <th style="text-align:left; padding:8px; border-bottom:1px dashed #2d3a55;">O₃</th>
              <th style="text-align:left; padding:8px; border-bottom:1px dashed #2d3a55;">CO</th>
            </tr>
          </thead>
          <tbody>
            {% for a in payload['air_quality'] %}
              <tr>
                <td style="padding:8px; border-bottom:1px dashed #2d3a55;">{{ a.get('time_ist') or "—" }}</td>
                <td style="padding:8px; border-bottom:1px dashed #2d3a55;">{{ a.get('us_aqi',"—") }}</td>
                <td style="padding:8px; border-bottom:1px dashed #2d3a55;">{{ a.get('pm2_5',"—") }}</td>
                <td style="padding:8px; border-bottom:1px dashed #2d3a55;">{{ a.get('pm10',"—") }}</td>
                <td style="padding:8px; border-bottom:1px dashed #2d3a55;">{{ a.get('nitrogen_dioxide',"—") }}</td>
                <td style="padding:8px; border-bottom:1px dashed #2d3a55;">{{ a.get('sulphur_dioxide',"—") }}</td>
                <td style="padding:8px; border-bottom:1px dashed #2d3a55;">{{ a.get('ozone',"—") }}</td>
                <td style="padding:8px; border-bottom:1px dashed #2d3a55;">{{ a.get('carbon_monoxide',"—") }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if payload['errors']['air'] %}
        <p class="muted">Air API error: {{ payload['errors']['air'] }}</p>
      {% endif %}
    </section>
  </div>

  <footer class="muted" style="text-align:center; padding:16px">
    Data: Open-Meteo • <a href="/start">Start Keep-Alive</a> • <a href="/ping">Ping</a>
  </footer>

  <!-- Data for JS -->
  <script>
    const HOURLY = {{ payload['hourly']|tojson }};
    const DAILY  = {{ payload['daily']|tojson }};
    const NOW_IST = "{{ now_ist }}";
  </script>

  <!-- Typeahead (unchanged) -->
  <script>
    const box = document.getElementById('place');
    const sugs = document.getElementById('sugs');
    let tmr = null;
    function hideSugs(){ sugs.classList.add('hidden'); sugs.innerHTML=''; }
    if (box){
      box.addEventListener('input', () => {
        const q = box.value.trim();
        if (tmr) clearTimeout(tmr);
        if (q.length < 3) { hideSugs(); return; }
        tmr = setTimeout(async () => {
          try {
            const res = await fetch(`/geo?q=${encodeURIComponent(q)}`);
            const data = await res.json();
            sugs.innerHTML='';
            (data.results||[]).forEach(r=>{
              const div=document.createElement('div');
              div.textContent=`${r.name}${r.admin1 ? ', '+r.admin1 : ''}${r.country ? ', '+r.country : ''}`;
              div.onclick=()=>{ location.href=`/?lat=${r.lat}&lon=${r.lon}&name=${encodeURIComponent(r.name||'Custom')}&region=${encodeURIComponent(r.admin1||r.country||'')}`; };
              sugs.appendChild(div);
            });
            (data.results||[]).length ? sugs.classList.remove('hidden') : hideSugs();
          }catch(e){ hideSugs(); }
        },250);
      });
      document.addEventListener('click',e=>{ if(!document.querySelector('.searchbox').contains(e.target)) hideSugs(); });
    }
  </script>

  <!-- Chart logic (day + mode switching) -->
  <script>
    // helpers
    function byDate(isoDate){ return HOURLY.filter(h => (h.time_ist||"").slice(0,10) === isoDate); }
    function seriesForDay(isoDate, key){ return byDate(isoDate).map(h => (h[key]==null ? NaN : Number(h[key]))); }
    function labelsForDay(isoDate){ return byDate(isoDate).map(h => (h.time_ist||"").slice(11,16)); }

    // canvas engine with HiDPI support
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    function fixDPI(){
      const ratio = window.devicePixelRatio || 1;
      const w = canvas.clientWidth, h = canvas.clientHeight;
      canvas.width = Math.round(w * ratio);
      canvas.height = Math.round(h * ratio);
      ctx.setTransform(ratio,0,0,ratio,0,0);
    }
    fixDPI(); addEventListener('resize', fixDPI);

    function clearChart(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
    function scaleY(vals, padding=20){
      const v = vals.filter(x => !Number.isNaN(x));
      if(!v.length) return {f:()=>canvas.clientHeight/2, min:0, max:1};
      let min = Math.min(...v), max = Math.max(...v);
      if(min===max){ min-=1; max+=1; }
      const H = canvas.clientHeight - padding*2;
      return { min,max, f:(y)=> padding + (max - y) * (H / (max - min)) };
    }
    function drawAxes(labels){
      ctx.strokeStyle = "rgba(255,255,255,.15)";
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,canvas.clientHeight-20); ctx.lineTo(canvas.clientWidth-10,canvas.clientHeight-20); ctx.stroke();
      ctx.fillStyle = "rgba(255,255,255,.6)";
      ctx.font = "12px system-ui";
      const step = (canvas.clientWidth-60)/Math.max(1,labels.length-1);
      labels.forEach((t,i)=>{ if(i%3===0){ ctx.fillText(t, 40+i*step-8, canvas.clientHeight-4); }});
    }
    function plotLine(labels, vals, yscale, color, dashed=false){
      ctx.save();
      if(dashed) ctx.setLineDash([6,4]);
      ctx.strokeStyle = color; ctx.lineWidth = 2;
      const step = (canvas.clientWidth-60)/Math.max(1,labels.length-1);
      ctx.beginPath();
      labels.forEach((_,i)=>{
        const x = 40 + i*step;
        const y = yscale.f(vals[i]);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
      ctx.restore();
    }

    const legend = document.getElementById('legend');
    const subtitle = document.getElementById('subtitle');
    function setLegend(items){
      legend.innerHTML='';
      items.forEach(it=>{
        const span=document.createElement('span');
        span.textContent=it.label;
        span.style.color=it.color;
        legend.appendChild(span);
      });
    }

    // controller state
    let currentDate = (document.querySelector('.day.active')?.dataset.date) || (NOW_IST.slice(0,10));
    let currentMode = document.querySelector('.mode button.active')?.dataset.mode || 'conditions';

    function draw(){
      const labels = labelsForDay(currentDate);
      clearChart();
      drawAxes(labels);

      if(currentMode==='conditions'){
        const actual = seriesForDay(currentDate,'temperature_2m');
        const feels  = seriesForDay(currentDate,'apparent_temperature');
        const s = scaleY(actual.concat(feels));
        plotLine(labels, actual, s, "#5bc0be", false);
        plotLine(labels, feels,  s, "#e0fbfc", true);
        setLegend([{label:'Actual',color:'#5bc0be'},{label:'Feels Like',color:'#e0fbfc'}]);
        subtitle.textContent = "The actual temperature.";
      } else if(currentMode==='uv'){
        const v = seriesForDay(currentDate,'uv_index');
        const s = scaleY(v.length ? v : [0,10]);
        plotLine(labels, v, s, "#ffd166");
        setLegend([{label:'UV Index',color:'#ffd166'}]);
        subtitle.textContent = "Estimated hourly UV index.";
      } else if(currentMode==='wind'){
        const v = seriesForDay(currentDate,'wind_speed_10m');
        const s = scaleY(v);
        plotLine(labels, v, s, "#a0c4ff");
        setLegend([{label:'Wind (km/h)',color:'#a0c4ff'}]);
        subtitle.textContent = "10 m wind speed.";
      } else if(currentMode==='precip'){
        const v = seriesForDay(currentDate,'precipitation_probability');
        const s = scaleY(v.length ? v : [0,100]);
        plotLine(labels, v, s, "#72efdd");
        setLegend([{label:'Chance of Precipitation %',color:'#72efdd'}]);
        subtitle.textContent = "Hourly chance of precipitation.";
      } else if(currentMode==='humidity'){
        const v = seriesForDay(currentDate,'relative_humidity_2m');
        const s = scaleY(v.length ? v : [0,100]);
        plotLine(labels, v, s, "#bde0fe");
        setLegend([{label:'Humidity %',color:'#bde0fe'}]);
        subtitle.textContent = "Relative humidity near 2 m.";
      } else if(currentMode==='visibility'){
        const v = seriesForDay(currentDate,'visibility');
        const s = scaleY(v);
        plotLine(labels, v, s, "#ffd6a5");
        setLegend([{label:'Visibility (m)',color:'#ffd6a5'}]);
        subtitle.textContent = "Estimated horizontal visibility.";
      } else if(currentMode==='pressure'){
        const v = seriesForDay(currentDate,'pressure_msl');
        const s = scaleY(v);
        plotLine(labels, v, s, "#caffbf");
        setLegend([{label:'MSL Pressure (hPa)',color:'#caffbf'}]);
        subtitle.textContent = "Mean sea-level pressure.";
      }
    }

    // initial draw
    draw();

    // interactions
    document.querySelectorAll('.mode button').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll('.mode button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;
        draw();
      };
    });

    document.querySelectorAll('.day').forEach(d=>{
      d.onclick=()=>{
        document.querySelectorAll('.day').forEach(x=>x.classList.remove('active'));
        d.classList.add('active');
        currentDate = d.dataset.date; // "YYYY-MM-DD"
        draw();
      };
    });
  </script>
</body>
</html>
