<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weather • {{ city }}, {{ region }}</title>
  <style>
    :root { --bg:#0b132b; --card:#1c2541; --mut:#3a506b; --acc:#5bc0be; --txt:#e0fbfc; --alert:#ff6b6b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--txt); }
    header { padding:12px 16px; border-bottom:1px solid var(--mut); position:sticky; top:0; background:linear-gradient(180deg,var(--bg),rgba(11,19,43,0.85)); backdrop-filter:saturate(1.2) blur(2px); }
    h1 { margin:0; font-size:1.1rem; }
    .wrap { max-width:1100px; margin:0 auto; padding:16px; display:grid; gap:16px; }
    .grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); }
    .card { background:var(--card); border:1px solid var(--mut); border-radius:12px; padding:16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:var(--mut); color:var(--txt); font-size:.85rem; }
    .muted { color:#cfe8ea; opacity:.85; }
    .kpi { display:flex; gap:16px; align-items:center; }
    .kpi .big { font-weight:800; font-size:2.2rem; min-width:6ch; }
    .blink { animation: bl 1s step-start infinite; color:#fff; background:var(--alert); border-radius:8px; padding:2px 6px; }
    @keyframes bl { 50% { opacity:.35; } }
    .sticky-table { max-height: 420px; overflow:auto; border:1px solid var(--mut); border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:.92rem; }
    th, td { padding:8px; border-bottom:1px dashed #2d3a55; text-align:left; white-space:nowrap; }
    .searchbox { position: relative; display:inline-block; }
    .searchbox input { padding:8px 12px; border-radius:8px; border:1px solid var(--mut); background:#0f1b3d; color:var(--txt); min-width:220px; }
    .suggestions { position:absolute; top:40px; left:0; right:0; background:#0f1b3d; border:1px solid var(--mut); border-radius:8px; max-height:240px; overflow:auto; z-index:5; }
    .suggestions div { padding:8px 10px; cursor:pointer; border-bottom:1px solid #1f2a4c; }
    .suggestions div:hover { background:#122252; }
    .more { cursor:pointer; color:var(--acc); text-decoration:underline; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between; gap:12px">
      <h1>Weather • {{ city }}, {{ region }} <span class="muted">| IST: {{ now_ist }}</span></h1>
      <div class="row">
        <a class="pill" href="/?city=durgapur">Durgapur</a>
        <a class="pill" href="/?city=kolkata">Kolkata</a>
        <div class="searchbox">
          <input id="place" type="text" placeholder="Search place…" autocomplete="off"/>
          <div id="sugs" class="suggestions hidden"></div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">

    <!-- TODAY FIRST -->
    <section class="card">
      <h2 style="margin-top:0">Today</h2>
      {% set t = payload['today'] %}
      <div class="kpi">
        <div class="big {{ 'blink' if t['alert'] else '' }}">
          {% if t['temperature'] is not none %}
            {{ t['temperature'] }}°C
          {% else %} — {% endif %}
        </div>
        <div>
          <div>
            Precip. Probability:
            <span class="{{ 'blink' if t['precip_alert'] else '' }}">
              {{ t['precip_prob'] if t['precip_prob'] is not none else "—" }}%
            </span>
          </div>
          <div class="muted">Tap <span class="more" data-target="#today-more">More</span> for details</div>
        </div>
      </div>

      <div id="today-more" class="hidden" style="margin-top:10px">
        {% set cur = payload['current'] %}
        <div class="row">
          <span class="pill">Condition: {{ cur['weather_desc'] or "—" }}</span>
          <span class="pill">Wind: {{ cur['windspeed'] if cur['windspeed'] is not none else "—" }} km/h</span>
          <span class="pill">Dir: {{ cur['winddirection'] if cur['winddirection'] is not none else "—" }}°</span>
          <span class="pill">Updated: {{ cur['time_ist'] or "—" }}</span>
          <span class="pill">Gen: {{ payload['meta']['generationtime_ms'] }} ms</span>
        </div>
      </div>
    </section>

    <!-- NEXT 7 DAYS (summary cards) -->
    <section class="card">
      <h2 style="margin-top:0">Next 7 Days</h2>
      <div class="grid">
        {% for d in payload['daily'] %}
          {% set temp_alert = (d['temperature_2m_max'] is not none and d['temperature_2m_max'] >= 35) or (d['temperature_2m_min'] is not none and d['temperature_2m_min'] <= 10) %}
          {% set precip_flag = d['precipitation_hours'] is not none and d['precipitation_hours'] > 0 %}
          <div class="card" style="padding:12px">
            <div class="row" style="justify-content:space-between">
              <strong>{{ d['date'] or "—" }}</strong>
              <span class="muted">{{ d.get('weather_desc','') }}</span>
            </div>
            <div class="row" style="margin-top:6px">
              <span class="pill {{ 'blink' if temp_alert else '' }}">
                Min/Max: {{ d['temperature_2m_min'] if d['temperature_2m_min'] is not none else "—" }} / {{ d['temperature_2m_max'] if d['temperature_2m_max'] is not none else "—" }} °C
              </span>
              <span class="pill {{ 'blink' if precip_flag else '' }}">
                Precip (sum/hrs): {{ d['precipitation_sum'] if d['precipitation_sum'] is not none else "—" }} / {{ d['precipitation_hours'] if d['precipitation_hours'] is not none else "—" }}
              </span>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="muted" style="margin-top:8px">Tap <span class="more" data-target="#days-more">More</span> to see UV, wind, sunrise/sunset.</div>

      <div id="days-more" class="hidden" style="margin-top:8px">
        <div class="sticky-table">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Min / Max (°C)</th>
                <th>Feels (°C)</th>
                <th>Precip (mm / hrs)</th>
                <th>Wind (km/h / Gust)</th>
                <th>Dir (°)</th>
                <th>Sunrise / Sunset (IST)</th>
                <th>UV Max</th>
              </tr>
            </thead>
            <tbody>
              {% for d in payload['daily'] %}
                <tr>
                  <td>{{ d['date'] or "—" }}</td>
                  <td>{{ (d['temperature_2m_min'] if d['temperature_2m_min'] is not none else "—") }} / {{ (d['temperature_2m_max'] if d['temperature_2m_max'] is not none else "—") }}</td>
                  <td>{{ (d['apparent_temperature_min'] if d['apparent_temperature_min'] is not none else "—") }} / {{ (d['apparent_temperature_max'] if d['apparent_temperature_max'] is not none else "—") }}</td>
                  <td>{{ (d['precipitation_sum'] if d['precipitation_sum'] is not none else "—") }} / {{ (d['precipitation_hours'] if d['precipitation_hours'] is not none else "—") }}</td>
                  <td>{{ (d['wind_speed_10m_max'] if d['wind_speed_10m_max'] is not none else "—") }} / {{ (d['wind_gusts_10m_max'] if d['wind_gusts_10m_max'] is not none else "—") }}</td>
                  <td>{{ d['wind_direction_10m_dominant'] if d['wind_direction_10m_dominant'] is not none else "—" }}</td>
                  <td>{{ d.get('sunrise_ist') or d.get('sunrise') or "—" }} / {{ d.get('sunset_ist') or d.get('sunset') or "—" }}</td>
                  <td>{{ d['uv_index_max'] if d['uv_index_max'] is not none else "—" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- HOURLY TABLE (hidden by default; expandable) -->
    <section class="card">
      <h2 style="margin-top:0">Hourly (Next 24 Hours)</h2>
      <div class="muted">Tap <span class="more" data-target="#hourly-more">More</span> to expand.</div>
      <div id="hourly-more" class="hidden">
        <div class="sticky-table" style="margin-top:8px">
          <table>
            <thead>
              <tr>
                <th>Time (IST)</th>
                <th>Temp</th>
                <th>Feels</th>
                <th>RH%</th>
                <th>DewPt</th>
                <th>Precip</th>
                <th>Rain</th>
                <th>Showers</th>
                <th>Snow</th>
                <th>SnowDepth</th>
                <th>PrecProb%</th>
                <th>Cloud%</th>
                <th>Vis (m)</th>
                <th>UV</th>
                <th>UV (Clear)</th>
                <th>Wind</th>
                <th>Gust</th>
                <th>Dir°</th>
                <th>MSL</th>
                <th>SurfP</th>
              </tr>
            </thead>
            <tbody>
              {% for h in payload['hourly'] %}
                <tr>
                  <td>{{ h.get('time_ist') or "—" }}</td>
                  <td>{{ h.get('temperature_2m', "—") }}</td>
                  <td>{{ h.get('apparent_temperature', "—") }}</td>
                  <td>{{ h.get('relative_humidity_2m', "—") }}</td>
                  <td>{{ h.get('dew_point_2m', "—") }}</td>
                  <td>{{ h.get('precipitation', "—") }}</td>
                  <td>{{ h.get('rain', "—") }}</td>
                  <td>{{ h.get('showers', "—") }}</td>
                  <td>{{ h.get('snowfall', "—") }}</td>
                  <td>{{ h.get('snow_depth', "—") }}</td>
                  <td>{{ h.get('precipitation_probability', "—") }}</td>
                  <td>{{ h.get('cloud_cover', "—") }}</td>
                  <td>{{ h.get('visibility', "—") }}</td>
                  <td>{{ h.get('uv_index', "—") }}</td>
                  <td>{{ h.get('uv_index_clear_sky', "—") }}</td>
                  <td>{{ h.get('wind_speed_10m', "—") }}</td>
                  <td>{{ h.get('wind_gusts_10m', "—") }}</td>
                  <td>{{ h.get('wind_direction_10m', "—") }}</td>
                  <td>{{ h.get('pressure_msl', "—") }}</td>
                  <td>{{ h.get('surface_pressure', "—") }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% if payload['errors']['forecast'] %}
        <p class="error small">Forecast error: {{ payload['errors']['forecast'] }}</p>
      {% endif %}
    </section>

    <!-- AIR QUALITY -->
    <section class="card">
      <h2 style="margin-top:0">Air Quality (Next 24 Hours)</h2>
      <div class="sticky-table">
        <table>
          <thead>
            <tr>
              <th>Time (IST)</th>
              <th>US AQI</th>
              <th>US AQI (PM2.5)</th>
              <th>US AQI (PM10)</th>
              <th>US AQI (NO₂)</th>
              <th>US AQI (O₃)</th>
              <th>US AQI (SO₂)</th>
              <th>US AQI (CO)</th>
              <th>PM2.5</th>
              <th>PM10</th>
              <th>NO₂</th>
              <th>SO₂</th>
              <th>O₃</th>
              <th>CO</th>
              <th>AOD</th>
              <th>Dust</th>
              <th>UV</th>
              <th>UV (Clear)</th>
            </tr>
          </thead>
          <tbody>
            {% for a in payload['air_quality'] %}
              <tr>
                <td>{{ a.get('time_ist') or "—" }}</td>
                <td>{{ a.get('us_aqi', "—") }}</td>
                <td>{{ a.get('us_aqi_pm2_5', "—") }}</td>
                <td>{{ a.get('us_aqi_pm10', "—") }}</td>
                <td>{{ a.get('us_aqi_no2', "—") }}</td>
                <td>{{ a.get('us_aqi_o3', "—") }}</td>
                <td>{{ a.get('us_aqi_so2', "—") }}</td>
                <td>{{ a.get('us_aqi_co', "—") }}</td>
                <td>{{ a.get('pm2_5', "—") }}</td>
                <td>{{ a.get('pm10', "—") }}</td>
                <td>{{ a.get('nitrogen_dioxide', "—") }}</td>
                <td>{{ a.get('sulphur_dioxide', "—") }}</td>
                <td>{{ a.get('ozone', "—") }}</td>
                <td>{{ a.get('carbon_monoxide', "—") }}</td>
                <td>{{ a.get('aerosol_optical_depth', "—") }}</td>
                <td>{{ a.get('dust', "—") }}</td>
                <td>{{ a.get('uv_index', "—") }}</td>
                <td>{{ a.get('uv_index_clear_sky', "—") }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if payload['errors']['air'] %}
        <p class="error small">Air Quality error: {{ payload['errors']['air'] }}</p>
      {% endif %}
    </section>
  </div>

  <footer class="muted" style="text-align:center; padding:16px">
    Data: Open-Meteo • <a href="/start">Start Keep-Alive</a> • <a href="/ping">Ping</a>
  </footer>

  <script>
    // expand/collapse
    document.querySelectorAll('.more').forEach(el => {
      el.addEventListener('click', () => {
        const sel = el.getAttribute('data-target');
        const tgt = document.querySelector(sel);
        if (tgt) tgt.classList.toggle('hidden');
      });
    });

    // typeahead search using /geo proxy
    const box = document.getElementById('place');
    const sugs = document.getElementById('sugs');
    let tmr = null;

    function hideSugs(){ sugs.classList.add('hidden'); sugs.innerHTML = ''; }

    box.addEventListener('input', () => {
      const q = box.value.trim();
      if (tmr) clearTimeout(tmr);
      if (q.length < 3) { hideSugs(); return; }
      tmr = setTimeout(async () => {
        try {
          const res = await fetch(`/geo?q=${encodeURIComponent(q)}`);
          const data = await res.json();
          sugs.innerHTML = '';
          (data.results || []).forEach(r => {
            const div = document.createElement('div');
            div.textContent = `${r.name}${r.admin1 ? ', ' + r.admin1 : ''}${r.country ? ', ' + r.country : ''}`;
            div.addEventListener('click', () => {
              const name = encodeURIComponent(r.name || 'Custom');
              const region = encodeURIComponent(r.admin1 || r.country || '');
              const url = `/?lat=${r.lat}&lon=${r.lon}&name=${name}&region=${region}`;
              window.location.href = url;
            });
            sugs.appendChild(div);
          });
          if ((data.results || []).length) {
            sugs.classList.remove('hidden');
          } else {
            hideSugs();
          }
        } catch(e) {
          hideSugs();
        }
      }, 250);
    });

    document.addEventListener('click', (e) => {
      if (!document.querySelector('.searchbox').contains(e.target)) hideSugs();
    });
  </script>
</body>
</html>
