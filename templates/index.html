<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weather • {{ city }}, {{ region }}</title>
  <style>
    :root { --bg:#0b132b; --card:#1c2541; --mut:#3a506b; --acc:#5bc0be; --txt:#e0fbfc; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--txt); }
    header { padding:16px 20px; border-bottom:1px solid var(--mut); position:sticky; top:0; background:linear-gradient(180deg,var(--bg),rgba(11,19,43,0.8)); backdrop-filter:saturate(1.2) blur(2px); }
    h1 { margin:0; font-size:1.25rem; }
    .muted { color:#cfe8ea; opacity:.8; }
    .wrap { max-width:1100px; margin:0 auto; padding:20px; display:grid; gap:16px; }
    .grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
    .card { background:var(--card); border:1px solid var(--mut); border-radius:12px; padding:16px; }
    .kpi { display:flex; gap:16px; align-items:center; }
    .kpi div { display:flex; flex-direction:column; }
    .kpi .big { font-weight:700; font-size:2rem; line-height:1; min-width:5ch; }
    table { width:100%; border-collapse:collapse; font-size:.92rem; }
    th, td { padding:8px; border-bottom:1px dashed #2d3a55; text-align:left; white-space:nowrap; }
    th { position:sticky; top:0; background:var(--card); }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:var(--mut); color:var(--txt); font-size:.85rem; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    a { color:var(--acc); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .error { color:#ffd7d7; }
    footer { padding:20px; text-align:center; color:#cfe8ea; opacity:.8; }
    .small { font-size:.85rem; }
    .sticky-table { max-height: 420px; overflow:auto; border:1px solid var(--mut); border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between">
      <h1>Weather • {{ city }}, {{ region }} <span class="muted">| IST: {{ now_ist }}</span></h1>
      <div class="row">
        <a class="pill" href="/?city=durgapur">Durgapur</a>
        <a class="pill" href="/?city=kolkata">Kolkata</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- Current -->
    <section class="grid">
      <div class="card">
        <h2>Current Weather</h2>
        {% set cur = payload.current %}
        <div class="kpi">
          <div class="big">
            {% if cur.temperature is not none %}
              {{ cur.temperature }}°C
            {% else %} — {% endif %}
          </div>
          <div>
            <span>{{ cur.weather_desc or "—" }}</span>
            <span class="muted small">Windspeed: {{ cur.windspeed if cur.windspeed is not none else "—" }} km/h</span>
            <span class="muted small">Direction: {{ cur.winddirection if cur.winddirection is not none else "—" }}°</span>
            <span class="muted small">Updated: {{ cur.time_ist or "—" }}</span>
          </div>
        </div>
        {% if payload.errors.forecast %}
          <p class="error small">Forecast error: {{ payload.errors.forecast }}</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>Meta</h2>
        <div class="row small">
          <span class="pill">TZ: {{ payload.meta.timezone or "—" }}</span>
          <span class="pill">Elevation: {{ payload.meta.elevation if payload.meta.elevation is not none else "—" }}</span>
          <span class="pill">Gen: {{ payload.meta.generationtime_ms }} ms</span>
        </div>
        <p class="small">APIs:
          <a href="{{ payload.meta.forecast_url }}" target="_blank" rel="noopener">Forecast</a> ·
          <a href="{{ payload.meta.air_quality_url }}" target="_blank" rel="noopener">Air Quality</a>
        </p>
      </div>
    </section>

    <!-- Daily -->
    <section class="card">
      <h2>Daily (Next 7 Days)</h2>
      <div class="sticky-table">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Min / Max (°C)</th>
              <th>Feels (°C)</th>
              <th>Precip (mm / hrs)</th>
              <th>Wind (km/h / Gust)</th>
              <th>Dir (°)</th>
              <th>Sunrise / Sunset (IST)</th>
              <th>UV Max</th>
            </tr>
          </thead>
          <tbody>
            {% for d in payload.daily %}
              <tr>
                <td>{{ d.date or "—" }}</td>
                <td>{{ (d.temperature_2m_min if d.temperature_2m_min is not none else "—") }} / {{ (d.temperature_2m_max if d.temperature_2m_max is not none else "—") }}</td>
                <td>{{ (d.apparent_temperature_min if d.apparent_temperature_min is not none else "—") }} / {{ (d.apparent_temperature_max if d.apparent_temperature_max is not none else "—") }}</td>
                <td>{{ (d.precipitation_sum if d.precipitation_sum is not none else "—") }} / {{ (d.precipitation_hours if d.precipitation_hours is not none else "—") }}</td>
                <td>{{ (d.wind_speed_10m_max if d.wind_speed_10m_max is not none else "—") }} / {{ (d.wind_gusts_10m_max if d.wind_gusts_10m_max is not none else "—") }}</td>
                <td>{{ d.wind_direction_10m_dominant if d.wind_direction_10m_dominant is not none else "—" }}</td>
                <td>{{ d.sunrise_ist or d.sunrise or "—" }} / {{ d.sunset_ist or d.sunset or "—" }}</td>
                <td>{{ d.uv_index_max if d.uv_index_max is not none else "—" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Hourly -->
    <section class="card">
      <h2>Hourly (Next 24 Hours)</h2>
      <div class="sticky-table">
        <table>
          <thead>
            <tr>
              <th>Time (IST)</th>
              <th>Temp</th>
              <th>Feels</th>
              <th>RH%</th>
              <th>DewPt</th>
              <th>Precip</th>
              <th>Rain</th>
              <th>Showers</th>
              <th>Snow</th>
              <th>SnowDepth</th>
              <th>PrecProb%</th>
              <th>Cloud%</th>
              <th>Vis (m)</th>
              <th>UV</th>
              <th>UV (Clear)</th>
              <th>Wind (km/h)</th>
              <th>Gust</th>
              <th>Dir°</th>
              <th>MSL (hPa)</th>
              <th>SurfP (hPa)</th>
            </tr>
          </thead>
          <tbody>
            {% for h in payload.hourly %}
              <tr>
                <td>{{ h.time_ist or "—" }}</td>
                <td>{{ h.temperature_2m if h.temperature_2m is not none else "—" }}</td>
                <td>{{ h.apparent_temperature if h.apparent_temperature is not none else "—" }}</td>
                <td>{{ h.relative_humidity_2m if h.relative_humidity_2m is not none else "—" }}</td>
                <td>{{ h.dew_point_2m if h.dew_point_2m is not none else "—" }}</td>
                <td>{{ h.precipitation if h.precipitation is not none else "—" }}</td>
                <td>{{ h.rain if h.rain is not none else "—" }}</td>
                <td>{{ h.showers if h.showers is not none else "—" }}</td>
                <td>{{ h.snowfall if h.snowfall is not none else "—" }}</td>
                <td>{{ h.snow_depth if h.snow_depth is not none else "—" }}</td>
                <td>{{ h.precipitation_probability if h.precipitation_probability is not none else "—" }}</td>
                <td>{{ h.cloud_cover if h.cloud_cover is not none else "—" }}</td>
                <td>{{ h.visibility if h.visibility is not none else "—" }}</td>
                <td>{{ h.uv_index if h.uv_index is not none else "—" }}</td>
                <td>{{ h.uv_index_clear_sky if h.uv_index_clear_sky is not none else "—" }}</td>
                <td>{{ h.wind_speed_10m if h.wind_speed_10m is not none else "—" }}</td>
                <td>{{ h.wind_gusts_10m if h.wind_gusts_10m is not none else "—" }}</td>
                <td>{{ h.wind_direction_10m if h.wind_direction_10m is not none else "—" }}</td>
                <td>{{ h.pressure_msl if h.pressure_msl is not none else "—" }}</td>
                <td>{{ h.surface_pressure if h.surface_pressure is not none else "—" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if payload.errors.forecast %}
        <p class="error small">Forecast error: {{ payload.errors.forecast }}</p>
      {% endif %}
    </section>

    <!-- Air Quality -->
    <section class="card">
      <h2>Air Quality (Next 24 Hours)</h2>
      <div class="sticky-table">
        <table>
          <thead>
            <tr>
              <th>Time (IST)</th>
              <th>US AQI</th>
              <th>US AQI (PM2.5)</th>
              <th>US AQI (PM10)</th>
              <th>US AQI (NO₂)</th>
              <th>US AQI (O₃)</th>
              <th>US AQI (SO₂)</th>
              <th>US AQI (CO)</th>
              <th>PM2.5</th>
              <th>PM10</th>
              <th>NO₂</th>
              <th>SO₂</th>
              <th>O₃</th>
              <th>CO</th>
              <th>AOD</th>
              <th>Dust</th>
              <th>UV</th>
              <th>UV (Clear)</th>
            </tr>
          </thead>
          <tbody>
            {% for a in payload.air_quality %}
              <tr>
                <td>{{ a.time_ist or "—" }}</td>
                <td>{{ a.us_aqi if a.us_aqi is not none else "—" }}</td>
                <td>{{ a.us_aqi_pm2_5 if a.us_aqi_pm2_5 is not none else "—" }}</td>
                <td>{{ a.us_aqi_pm10 if a.us_aqi_pm10 is not none else "—" }}</td>
                <td>{{ a.us_aqi_no2 if a.us_aqi_no2 is not none else "—" }}</td>
                <td>{{ a.us_aqi_o3 if a.us_aqi_o3 is not none else "—" }}</td>
                <td>{{ a.us_aqi_so2 if a.us_aqi_so2 is not none else "—" }}</td>
                <td>{{ a.us_aqi_co if a.us_aqi_co is not none else "—" }}</td>
                <td>{{ a.pm2_5 if a.pm2_5 is not none else "—" }}</td>
                <td>{{ a.pm10 if a.pm10 is not none else "—" }}</td>
                <td>{{ a.nitrogen_dioxide if a.nitrogen_dioxide is not none else "—" }}</td>
                <td>{{ a.sulphur_dioxide if a.sulphur_dioxide is not none else "—" }}</td>
                <td>{{ a.ozone if a.ozone is not none else "—" }}</td>
                <td>{{ a.carbon_monoxide if a.carbon_monoxide is not none else "—" }}</td>
                <td>{{ a.aerosol_optical_depth if a.aerosol_optical_depth is not none else "—" }}</td>
                <td>{{ a.dust if a.dust is not none else "—" }}</td>
                <td>{{ a.uv_index if a.uv_index is not none else "—" }}</td>
                <td>{{ a.uv_index_clear_sky if a.uv_index_clear_sky is not none else "—" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if payload.errors.air %}
        <p class="error small">Air Quality error: {{ payload.errors.air }}</p>
      {% endif %}
    </section>
  </div>

  <footer class="small">
    Data: Open-Meteo • Toggle city:
    <a href="/?city=durgapur">Durgapur</a> ·
    <a href="/?city=kolkata">Kolkata</a> •
    <a href="/start">Start Keep-Alive</a> • <a href="/ping">Ping</a>
  </footer>
</body>
</html>
